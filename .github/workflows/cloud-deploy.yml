name: XMind MCP Cloud Service

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-cloud-service:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install fastapi uvicorn openpyxl beautifulsoup4 python-docx
    
    - name: Start MCP Server
      run: |
        python xmind_mcp_server.py &
        sleep 10
        curl -f http://localhost:8080/health || exit 1
    
    - name: Deploy to Render
      if: github.ref == 'refs/heads/main'
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      run: |
        # è¿™é‡Œå¯ä»¥æ·»åŠ éƒ¨ç½²åˆ°Render.comæˆ–å…¶ä»–äº‘æœåŠ¡çš„é€»è¾‘
        echo "Deploying to cloud service..."
    
    - name: Create Service URL
      run: |
        echo "ğŸš€ MCP Server is ready!"
        echo "API Documentation: http://localhost:8080/docs"
        echo "Health Check: http://localhost:8080/health"

  build-docker:
    runs-on: ubuntu-latest
    needs: deploy-cloud-service
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker Image
      run: |
        docker build -t xmind-mcp-server:latest .
    
    - name: Test Docker Image
      run: |
        docker run -d -p 8080:8080 --name test-server xmind-mcp-server:latest
        sleep 15
        curl -f http://localhost:8080/health || exit 1
        docker stop test-server
        docker rm test-server