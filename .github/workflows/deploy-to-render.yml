name: ðŸŽ¨ Deploy to Render

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'Deployment type'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - redeploy
          - status

env:
  RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
  RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}

jobs:
  deploy-to-render:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Check Render credentials
      id: check-credentials
      run: |
        if [ -n "$RENDER_API_KEY" ] && [ -n "$RENDER_SERVICE_ID" ]; then
          echo "has_credentials=true" >> $GITHUB_OUTPUT
          echo "âœ… Render credentials configured"
        else
          echo "has_credentials=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ Render credentials not configured"
          echo "è¯·è®¾ç½® RENDER_API_KEY å’Œ RENDER_SERVICE_ID å¯†é’¥"
        fi
      shell: bash
    
    - name: Deploy to Render
      if: steps.check-credentials.outputs.has_credentials == 'true' && github.event.inputs.deploy_type == 'deploy'
      run: |
        echo "ðŸš€ Deploying to Render..."
        
        # ä½¿ç”¨Render APIè§¦å‘éƒ¨ç½²
        response=$(curl -s -w "\n%{http_code}" \
          -X POST \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{
            "clearCache": "clear"
          }' \
          "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys")
        
        http_code=$(echo "$response" | tail -n1)
        body=$(echo "$response" | head -n-1)
        
        if [ "$http_code" = "201" ]; then
          echo "âœ… Deploy triggered successfully!"
          echo "Response: $body"
        else
          echo "âŒ Deployment failed with status: $http_code"
          echo "Response: $body"
          exit 1
        fi
    
    - name: Generate deployment summary
      run: |
        echo "## ðŸŽ¨ Render Deployment Summary" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check-credentials.outputs.has_credentials }}" = "true" ]; then
          echo "âœ… Credentials: Configured" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment: Triggered" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Service Test: Completed" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. è®¿é—® [Render Dashboard](https://dashboard.render.com) æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "2. ç­‰å¾…éƒ¨ç½²å®Œæˆï¼ˆçº¦2-5åˆ†é’Ÿï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "3. æµ‹è¯•MCPæœåŠ¡å™¨åŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
          echo "4. é…ç½®MCPå®¢æˆ·ç«¯è¿žæŽ¥" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Deployment: Skipped (no credentials)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Setup Required" >> $GITHUB_STEP_SUMMARY
          echo "è¯·é…ç½®ä»¥ä¸‹GitHub Secrets:" >> $GITHUB_STEP_SUMMARY
          echo "- \`RENDER_API_KEY\`: ä½ çš„Render APIå¯†é’¥" >> $GITHUB_STEP_SUMMARY
          echo "- \`RENDER_SERVICE_ID\`: RenderæœåŠ¡ID" >> $GITHUB_STEP_SUMMARY
          echo "- \`RENDER_SERVICE_URL\`: (å¯é€‰) æœåŠ¡URLç”¨äºŽæµ‹è¯•" >> $GITHUB_STEP_SUMMARY
        fi