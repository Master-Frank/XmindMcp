name: 🎨 Deploy to Render

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'Deployment type'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - redeploy
          - status

env:
  RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
  RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}

jobs:
  deploy-to-render:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Check Render credentials
      id: check-credentials
      run: |
        if [ -n "$RENDER_API_KEY" ] && [ -n "$RENDER_SERVICE_ID" ]; then
          echo "has_credentials=true" >> $GITHUB_OUTPUT
          echo "✅ Render credentials configured"
        else
          echo "has_credentials=false" >> $GITHUB_OUTPUT
          echo "⚠️ Render credentials not configured"
          echo "请设置 RENDER_API_KEY 和 RENDER_SERVICE_ID 密钥"
        fi
      shell: bash
    
    - name: Deploy to Render
      if: steps.check-credentials.outputs.has_credentials == 'true' && github.event.inputs.deploy_type == 'deploy'
      run: |
        echo "🚀 Deploying to Render..."
        
        # 使用Render API触发部署
        response=$(curl -s -w "\n%{http_code}" \
          -X POST \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{
            "clearCache": "clear"
          }' \
          "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys")
        
        http_code=$(echo "$response" | tail -n1)
        body=$(echo "$response" | head -n-1)
        
        if [ "$http_code" = "201" ]; then
          echo "✅ Deploy triggered successfully!"
          echo "Response: $body"
        else
          echo "❌ Deployment failed with status: $http_code"
          echo "Response: $body"
          exit 1
        fi
    
    - name: Generate deployment summary
      run: |
        echo "## 🎨 Render Deployment Summary" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check-credentials.outputs.has_credentials }}" = "true" ]; then
          echo "✅ Credentials: Configured" >> $GITHUB_STEP_SUMMARY
          echo "✅ Deployment: Triggered" >> $GITHUB_STEP_SUMMARY
          echo "✅ Service Test: Completed" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📋 Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. 访问 [Render Dashboard](https://dashboard.render.com) 查看部署状态" >> $GITHUB_STEP_SUMMARY
          echo "2. 等待部署完成（约2-5分钟）" >> $GITHUB_STEP_SUMMARY
          echo "3. 测试MCP服务器功能" >> $GITHUB_STEP_SUMMARY
          echo "4. 配置MCP客户端连接" >> $GITHUB_STEP_SUMMARY
        else
          echo "⚠️ Deployment: Skipped (no credentials)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🔧 Setup Required" >> $GITHUB_STEP_SUMMARY
          echo "请配置以下GitHub Secrets:" >> $GITHUB_STEP_SUMMARY
          echo "- \`RENDER_API_KEY\`: 你的Render API密钥" >> $GITHUB_STEP_SUMMARY
          echo "- \`RENDER_SERVICE_ID\`: Render服务ID" >> $GITHUB_STEP_SUMMARY
          echo "- \`RENDER_SERVICE_URL\`: (可选) 服务URL用于测试" >> $GITHUB_STEP_SUMMARY
        fi